<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Views.Pages.EditOrderPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:MyShop.Converters"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:PriceConverter x:Key="PriceConverter"/>
        <converters:DiscountTypeToUnitConverter x:Key="DiscountTypeToUnitConverter"/>
    </Page.Resources>

    <Grid RowSpacing="0" ColumnSpacing="0" x:Name="MainGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Back Button Header -->
        <Border
            Grid.Row="0"
            Padding="20,12,20,12"
            BorderThickness="0,0,0,1"
            BorderBrush="{ThemeResource ControlElevationBorderBrush}"
            Background="{ThemeResource SystemChromeLowColor}"
            x:Name="HeaderPanel">
            <Button
                Content="← Back"
                Click="OnBackClicked"
                Style="{StaticResource TextBlockButtonStyle}"/>
        </Border>

        <!-- Page Title -->
        <Border
            Grid.Row="1"
            Padding="20,12,20,12"
            Background="{ThemeResource SystemChromeLowColor}">
            <TextBlock
                Style="{StaticResource HeaderTextBlockStyle}">
                <Run Text="Edit Order #"/>
                <Run Text="{Binding CurrentOrder.OrderId}"/>
            </TextBlock>
        </Border>

        <!-- Content -->
        <ScrollViewer
            Grid.Row="2"
            VerticalScrollBarVisibility="Auto"
            HorizontalScrollBarVisibility="Disabled"
            Padding="20">
            <StackPanel Spacing="20">
                <!-- Status Selector Section -->
                <StackPanel Spacing="10" x:Name="StatusPanel">
                    <TextBlock
                        FontSize="14"
                        FontWeight="SemiBold"
                        Text="Order Status"/>
                    
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="Status:"/>
                        <ComboBox
                            MinWidth="150"
                            SelectedItem="{Binding SelectedStatus, Mode=TwoWay}">
                            <x:String>Created</x:String>
                            <x:String>Paid</x:String>
                            <x:String>Cancelled</x:String>
                        </ComboBox>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,8,0,0">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="Promotion:"/>
                        <ComboBox
                            MinWidth="200"
                            x:Name="PromotionComboBox"
                            ItemsSource="{Binding AvailablePromotions}"
                            SelectedItem="{Binding SelectedPromotion, Mode=TwoWay}"
                            DisplayMemberPath="Code"
                            PlaceholderText="Select promotion (optional)">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="{Binding Code}" FontWeight="SemiBold"/>
                                        <TextBlock Text=" - "/>
                                        <TextBlock Text="{Binding DiscountValue}"/>
                                        <TextBlock Text="{Binding DiscountType, Converter={StaticResource DiscountTypeToUnitConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                </StackPanel>

                <!-- Items Section (Read-Only) -->
                <StackPanel Spacing="10">
                    <TextBlock
                        FontSize="14"
                        FontWeight="SemiBold"
                        Text="Order Items (Read-Only)"/>

                    <!-- Items DataGrid with left alignment -->
                    <Border
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        BorderThickness="1"
                        BorderBrush="{ThemeResource ControlElevationBorderBrush}"
                        CornerRadius="4"
                        HorizontalAlignment="Left">
                        <controls:DataGrid
                            x:Name="OrderItemsDataGrid"
                            AutoGenerateColumns="False"
                            CanUserReorderColumns="False"
                            CanUserResizeColumns="True"
                            GridLinesVisibility="All"
                            ItemsSource="{Binding OrderItems}"
                            BorderThickness="0"
                            MaxHeight="350"
                            Width="900">
                            
                            <controls:DataGrid.Columns>
                                <controls:DataGridTextColumn
                                    Header="Product Name"
                                    Binding="{Binding OrderItem.Product.Name}"
                                    Width="400"/>
                                <controls:DataGridTextColumn
                                    Header="Qty"
                                    Binding="{Binding Quantity}"
                                    Width="80"/>
                                <controls:DataGridTextColumn
                                    Header="Unit Price"
                                    Binding="{Binding OrderItem.UnitSalePrice, Converter={StaticResource PriceConverter}}"
                                    Width="150"/>
                                <controls:DataGridTextColumn
                                    Header="Total"
                                    Binding="{Binding TotalPrice, Converter={StaticResource PriceConverter}}"
                                    Width="150"/>
                            </controls:DataGrid.Columns>
                        </controls:DataGrid>
                    </Border>
                </StackPanel>

                <!-- Total Price Footer -->
                <StackPanel
                    Orientation="Horizontal"
                    HorizontalAlignment="Left"
                    Spacing="12"
                    Margin="0,10,0,0"
                    BorderThickness="0,1,0,0"
                    BorderBrush="{ThemeResource ControlElevationBorderBrush}"
                    Padding="0,20,0,0">
                    <TextBlock
                        FontSize="14"
                        FontWeight="SemiBold"
                        VerticalAlignment="Center"
                        Text="Total Price:"/>
                    <TextBlock
                        FontSize="16"
                        FontWeight="Bold"
                        Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                        Text="{Binding CurrentOrder.FinalPrice, Converter={StaticResource PriceConverter}}"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- Action Buttons Footer -->
        <Border
            Grid.Row="3"
            Padding="20"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderThickness="0,1,0,0"
            BorderBrush="{ThemeResource ControlElevationBorderBrush}"
            Margin="20,15,20,20">
            <StackPanel
                Orientation="Horizontal"
                Spacing="10"
                HorizontalAlignment="Right"
                x:Name="ButtonPanel">
                <Button
                    Content="Save Status"
                    Click="OnSaveClicked"
                    Style="{StaticResource AccentButtonStyle}"/>
            </StackPanel>
        </Border>
    </Grid>
</Page>