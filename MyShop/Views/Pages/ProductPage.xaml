<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Views.Pages.ProductPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:MyShop.Data.Models"
    xmlns:converters="using:MyShop.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource LayerFillColorDefaultBrush}">

    <Page.Resources>
        <!-- Converters -->
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <converters:InverseCountToVisibilityConverter x:Key="InverseCountToVisibilityConverter"/>
        <converters:StringToImageSourceConverter x:Key="StringToImageSourceConverter"/>
    </Page.Resources>

    <Grid Padding="24,20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Filters -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="Auto"/> <!-- Pagination -->
        </Grid.RowDefinitions>

        <!-- Header Section - Compact -->
        <Grid Grid.Row="0" Padding="20,16" Background="{ThemeResource SystemChromeLowColor}" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Title and Status -->
            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                <TextBlock Text="Product Management" Style="{StaticResource TitleTextBlockStyle}"/>
                <TextBlock x:Name="StatusTextBlock" 
                          Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                          Style="{StaticResource CaptionTextBlockStyle}" 
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                          Margin="0,4,0,0"/>
            </StackPanel>

            <!-- Action Buttons - Compact -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <!-- Primary Action -->
                <Button x:Name="AddProductButton"
                        Style="{StaticResource AccentButtonStyle}"
                        Click="OnAddProductClick"
                        Visibility="{x:Bind ViewModel.CanCreateProducts, Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE710;" FontSize="14"/>
                        <TextBlock Text="Add Product"/>
                    </StackPanel>
                </Button>

                <!-- Secondary Actions Menu -->
                <DropDownButton Content="More">
                    <DropDownButton.Flyout>
                        <MenuFlyout Placement="Bottom">
                            <MenuFlyoutItem Text="Add Category" 
                                           Click="OnAddCategoryClick"
                                           Visibility="{x:Bind ViewModel.CanCreateCategories, Mode=OneWay}">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE8F4;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutSeparator/>
                            <MenuFlyoutItem x:Name="ImportMenuItem" Text="Import from Excel" Click="OnImportClick">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE8B5;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem x:Name="DownloadTemplateMenuItem" Text="Download Template" Click="OnDownloadTemplateClick">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE896;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                        </MenuFlyout>
                    </DropDownButton.Flyout>
                </DropDownButton>

                <!-- Refresh Button -->
                <Button Command="{x:Bind ViewModel.RefreshCommand}" 
                        ToolTipService.ToolTip="Refresh (F5)">
                    <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Search and Filter Section -->
        <Border Grid.Row="1" 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="16"
                Margin="0,0,0,12">
            
            <StackPanel Spacing="12">
                <!-- Search Row with Filter Toggle -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <AutoSuggestBox Grid.Column="0"
                                   PlaceholderText="Search products by name..."
                                   QueryIcon="Find"
                                   Text="{x:Bind ViewModel.SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                   QuerySubmitted="OnSearchQuerySubmitted"
                                   VerticalAlignment="Center"/>

                    <Button Grid.Column="1"
                           Command="{x:Bind ViewModel.SearchCommand}"
                           Style="{StaticResource AccentButtonStyle}"
                           Margin="8,0,0,0"
                           ToolTipService.ToolTip="Search">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE721;" FontSize="14"/>
                            <TextBlock Text="Search"/>
                        </StackPanel>
                    </Button>

                    <!-- Filter Toggle Button -->
                    <ToggleButton x:Name="FilterToggleButton"
                                 Grid.Column="2"
                                 Margin="8,0,0,0"
                                 Click="OnFilterToggleClick"
                                 ToolTipService.ToolTip="Show/Hide Filters">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE71C;" FontSize="14"/>
                            <TextBlock Text="Filters"/>
                            <FontIcon x:Name="FilterToggleIcon" Glyph="&#xE70D;" FontSize="10"/>
                        </StackPanel>
                    </ToggleButton>
                </Grid>

                <!-- Collapsible Filters Section -->
                <StackPanel x:Name="FiltersPanel" Visibility="Collapsed" Spacing="12">
                    <!-- Divider -->
                    <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}"/>

                    <!-- Filters Row -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="160"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Category -->
                        <TextBlock Grid.Column="0" Text="Category:" VerticalAlignment="Center" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,8,0"/>
                        <ComboBox x:Name="CategoryFilter"
                                 Grid.Column="1"
                                 PlaceholderText="All"
                                 ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}"
                                 SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}"
                                 DisplayMemberPath="Name"
                                 HorizontalAlignment="Stretch"
                                 SelectionChanged="OnCategoryFilterChanged"/>

                        <!-- Price Range -->
                        <TextBlock Grid.Column="2" Text="Price:" VerticalAlignment="Center" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="16,0,8,0"/>
                        <NumberBox Grid.Column="3"
                                  PlaceholderText="Min"
                                  Value="{x:Bind ViewModel.MinPrice, Mode=TwoWay}"
                                  SpinButtonPlacementMode="Hidden"
                                  Minimum="0"
                                  HorizontalAlignment="Stretch"/>
                        <TextBlock Grid.Column="4" Text="–" VerticalAlignment="Center" Margin="6,0"
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <NumberBox Grid.Column="5"
                                  PlaceholderText="Max"
                                  Value="{x:Bind ViewModel.MaxPrice, Mode=TwoWay}"
                                  SpinButtonPlacementMode="Hidden"
                                  Minimum="0"
                                  HorizontalAlignment="Stretch"/>

                        <!-- Sort -->
                        <TextBlock Grid.Column="6" Text="Sort:" VerticalAlignment="Center" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="16,0,8,0"/>
                        <ComboBox Grid.Column="7"
                                 ItemsSource="{x:Bind ViewModel.SortOptions}"
                                 SelectedItem="{x:Bind ViewModel.SelectedSortCriteria, Mode=TwoWay}"
                                 HorizontalAlignment="Stretch"
                                 SelectionChanged="OnSortChanged"/>

                        <!-- Items Per Page -->
                        <TextBlock Grid.Column="8" Text="Show:" VerticalAlignment="Center" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="16,0,8,0"/>
                        <ComboBox x:Name="ItemsPerPageCombo"
                                 Grid.Column="9"
                                 SelectionChanged="OnItemsPerPageChanged"
                                 HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="5" Tag="5"/>
                            <ComboBoxItem Content="10" Tag="10" IsSelected="True"/>
                            <ComboBoxItem Content="15" Tag="15"/>
                            <ComboBoxItem Content="20" Tag="20"/>
                            <ComboBoxItem Content="25" Tag="25"/>
                        </ComboBox>

                        <!-- Action Buttons -->
                        <StackPanel Grid.Column="11" Orientation="Horizontal" Spacing="8">
                            <Button Command="{x:Bind ViewModel.ApplyPriceFilterCommand}"
                                   Style="{StaticResource AccentButtonStyle}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE73E;" FontSize="12"/>
                                    <TextBlock Text="Apply"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{x:Bind ViewModel.ClearFiltersCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xE894;" FontSize="12"/>
                                    <TextBlock Text="Clear"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Products Grid -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Loading Indicator - Show when loading -->
            <Grid x:Name="LoadingPanel" 
                  Visibility="Collapsed"
                  Background="{ThemeResource LayerFillColorDefaultBrush}">
                <ProgressRing IsActive="True"
                             Width="60"
                             Height="60"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"/>
            </Grid>

            <!-- Content ScrollViewer -->
            <ScrollViewer x:Name="ContentScrollViewer" 
                         VerticalScrollBarVisibility="Auto">
                <Grid>
                    <!-- Products List -->
                    <ListView x:Name="ProductsListView"
                             ItemsSource="{x:Bind ViewModel.Products, Mode=OneWay}"
                             SelectedItem="{x:Bind ViewModel.SelectedProduct, Mode=TwoWay}"
                             SelectionMode="Single">
                        
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="local:Product">
                                <Grid Padding="16,12"
                                     Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                     BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                     BorderThickness="1"
                                     CornerRadius="8"
                                     Margin="0,0,0,8">
                                    
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>    <!-- Image -->
                                        <ColumnDefinition Width="*"/>     <!-- Details -->
                                        <ColumnDefinition Width="Auto"/>  <!-- Actions -->
                                    </Grid.ColumnDefinitions>

                                    <!-- Product Image -->
                                    <Border Grid.Column="0"
                                           Width="64"
                                           Height="64"
                                           CornerRadius="4"
                                           Background="{ThemeResource LayerFillColorAltBrush}"
                                           HorizontalAlignment="Left">
                                        <Image Source="{x:Bind PrimaryImageUrl, Converter={StaticResource StringToImageSourceConverter}}"
                                              Stretch="UniformToFill"/>
                                    </Border>

                                    <!-- Product Details -->
                                    <StackPanel Grid.Column="1" Margin="16,0" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Name}"
                                                  Style="{StaticResource BodyStrongTextBlockStyle}"
                                                  TextTrimming="CharacterEllipsis"/>
                                        
                                        <TextBlock Margin="0,4,0,0" Style="{StaticResource CaptionTextBlockStyle}">
                                            <Run Text="SKU:"/>
                                            <Run Text="{x:Bind Sku}" FontWeight="SemiBold"/>
                                            <Run Text=" | Category: "/>
                                            <Run Text="{x:Bind Category.Name}" FontWeight="SemiBold"/>
                                        </TextBlock>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="16">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE8EC;" FontSize="14" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="{x:Bind ImportPrice}" FontWeight="SemiBold"/>
                                                <TextBlock Text="₫" FontSize="12" Opacity="0.8"/>
                                            </StackPanel>
                                            
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE7B8;" FontSize="14" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="Stock:"/>
                                                <TextBlock Text="{x:Bind Count}" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Action Buttons -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <Button Click="OnViewProductClick" Tag="{x:Bind ProductId}" ToolTipService.ToolTip="View Details">
                                            <FontIcon Glyph="&#xE700;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnEditProductClick" Tag="{x:Bind ProductId}" ToolTipService.ToolTip="Edit Product">
                                            <FontIcon Glyph="&#xE70F;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnDeleteProductClick"
                                               Tag="{x:Bind ProductId}"
                                               ToolTipService.ToolTip="Delete Product"
                                               Visibility="{Binding ElementName=PageRoot, Path=ViewModel.CanDeleteProducts, Mode=OneWay}">
                                            <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Empty State - Show when no products -->
                    <StackPanel x:Name="EmptyStatePanel"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Spacing="16"
                               Visibility="Collapsed">
                        <FontIcon Glyph="&#xE7C3;" FontSize="64" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                        <TextBlock Text="No products found"
                                  Style="{StaticResource SubtitleTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="Try adjusting your filters or add a new product"
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                  TextAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Pagination Section -->
        <Grid Grid.Row="3"
              Padding="16,12"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="0,16,0,0">
            
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Previous Button -->
            <Button Grid.Column="0"
                   Command="{x:Bind ViewModel.PreviousPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE76B;" FontSize="14"/>
                    <TextBlock Text="Previous"/>
                </StackPanel>
            </Button>

            <!-- Page Info -->
            <StackPanel Grid.Column="1" 
                       Orientation="Horizontal" 
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Spacing="8">
                <TextBlock Text="Page"/>
                <TextBlock Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="of"/>
                <TextBlock Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="•" Margin="8,0"/>
                <TextBlock Text="{x:Bind ViewModel.TotalCount, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="total products"/>
            </StackPanel>

            <!-- Next Button -->
            <Button Grid.Column="2"
                   Command="{x:Bind ViewModel.NextPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Next"/>
                    <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Onboarding Teaching Tip -->
        <TeachingTip
            x:Name="OnboardingTip"
            Title="Welcome!"
            Subtitle="Let's get started"
            ActionButtonContent="Next"
            ActionButtonClick="OnOnboardingNextClicked"
            CloseButtonContent="Skip Tour"
            CloseButtonClick="OnOnboardingSkipClicked"
            PreferredPlacement="Bottom"
            IsLightDismissEnabled="False"
            ShouldConstrainToRootBounds="False">
        </TeachingTip>
    </Grid>
</Page>
