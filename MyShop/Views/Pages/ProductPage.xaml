<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Views.Pages.ProductPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:MyShop.Data.Models"
    xmlns:converters="using:MyShop.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource LayerFillColorDefaultBrush}">

    <Page.Resources>
        <!-- Converters -->
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <converters:InverseCountToVisibilityConverter x:Key="InverseCountToVisibilityConverter"/>
        <converters:StringToImageSourceConverter x:Key="StringToImageSourceConverter"/>
    </Page.Resources>

    <Grid Padding="24,20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Filters -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="Auto"/> <!-- Pagination -->
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <StackPanel Grid.Row="0" Padding="20" Background="{ThemeResource SystemChromeLowColor}" Margin="0,0,0,16">
            <TextBlock Text="Product Management" Style="{StaticResource HeaderTextBlockStyle}" Margin="0,0,0,10"/>
            <TextBlock x:Name="StatusTextBlock" 
                      Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                      Style="{StaticResource SubtitleTextBlockStyle}" 
                      Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
            <StackPanel x:Name="AddProductButton" Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                <Button Content="Add Product"
                       Click="OnAddProductClick"
                       Style="{StaticResource AccentButtonStyle}"
                       Visibility="{x:Bind ViewModel.CanCreateProducts, Mode=OneWay}">
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Add new product (Ctrl+N)"/>
                    </ToolTipService.ToolTip>
                </Button>
                
                <Button Content="Add Category"
                       Click="OnAddCategoryClick"
                       Visibility="{x:Bind ViewModel.CanCreateCategories, Mode=OneWay}">
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Add new category"/>
                    </ToolTipService.ToolTip>
                </Button>
                
                <Button x:Name="ImportButton" Content="Import" Click="OnImportClick">
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Import products from Excel"/>
                    </ToolTipService.ToolTip>
                </Button>

                <Button x:Name="DownloadTemplateButton" Content="ðŸ“¥ Download Template" Click="OnDownloadTemplateClick">
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Download Excel template for bulk import"/>
                    </ToolTipService.ToolTip>
                </Button>
                
                <Button Command="{x:Bind ViewModel.RefreshCommand}">
                    <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Refresh (F5)"/>
                    </ToolTipService.ToolTip>
                </Button>
            </StackPanel>
        </StackPanel>

        <!-- Filter Section -->
        <Grid Grid.Row="1" 
              Padding="16"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="0,0,0,16">
            
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- First row: Category, Price Range, Search -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Category Filter -->
                <ComboBox x:Name="CategoryFilter"
                         Grid.Column="0"
                         Header="Category"
                         PlaceholderText="All Categories"
                         ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}"
                         SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}"
                         DisplayMemberPath="Name"
                         HorizontalAlignment="Stretch"
                         SelectionChanged="OnCategoryFilterChanged"/>

                <!-- Min Price -->
                <NumberBox Grid.Column="2"
                          Header="Min Price"
                          PlaceholderText="Any"
                          Value="{x:Bind ViewModel.MinPrice, Mode=TwoWay}"
                          SpinButtonPlacementMode="Compact"
                          Minimum="0"
                          HorizontalAlignment="Stretch"/>

                <!-- Max Price -->
                <NumberBox Grid.Column="4"
                          Header="Max Price"
                          PlaceholderText="Any"
                          Value="{x:Bind ViewModel.MaxPrice, Mode=TwoWay}"
                          SpinButtonPlacementMode="Compact"
                          Minimum="0"
                          HorizontalAlignment="Stretch"/>

                <!-- Search Box -->
                <Grid Grid.Column="6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox Grid.Column="0"
                            Header="Search"
                            PlaceholderText="Search by product name..."
                            Text="{x:Bind ViewModel.SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            HorizontalAlignment="Stretch"
                            KeyDown="OnSearchKeyDown"/>

                    <Button Grid.Column="1"
                           Command="{x:Bind ViewModel.SearchCommand}"
                           Margin="8,26,0,0"
                           VerticalAlignment="Bottom"
                           Style="{StaticResource AccentButtonStyle}">
                        <FontIcon Glyph="&#xE721;" FontSize="16"/>
                        <ToolTipService.ToolTip>
                            <ToolTip Content="Search (Enter)"/>
                        </ToolTipService.ToolTip>
                    </Button>
                </Grid>

                <!-- Apply Filters Button -->
                <Button Grid.Column="7"
                       Content="Apply Filters"
                       Command="{x:Bind ViewModel.ApplyPriceFilterCommand}"
                       Margin="12,26,0,0"
                       VerticalAlignment="Bottom"/>
            </Grid>

            <!-- Second row: Sort By, Items Per Page, and Clear Filters -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Sort By -->
                <ComboBox Grid.Column="0"
                         Header="Sort By"
                         ItemsSource="{x:Bind ViewModel.SortOptions}"
                         SelectedItem="{x:Bind ViewModel.SelectedSortCriteria, Mode=TwoWay}"
                         HorizontalAlignment="Stretch"
                         SelectionChanged="OnSortChanged"/>

                <!-- Items Per Page -->
                <ComboBox x:Name="ItemsPerPageCombo"
                         Grid.Column="2"
                         Header="Items Per Page"
                         SelectionChanged="OnItemsPerPageChanged"
                         HorizontalAlignment="Stretch">
                    <ComboBoxItem Content="5 Items" Tag="5" IsSelected="False"/>
                    <ComboBoxItem Content="10 Items" Tag="10" IsSelected="True"/>
                    <ComboBoxItem Content="15 Items" Tag="15" IsSelected="False"/>
                    <ComboBoxItem Content="20 Items" Tag="20" IsSelected="False"/>
                    <ComboBoxItem Content="25 Items" Tag="25" IsSelected="False"/>
                </ComboBox>

                <!-- Clear Filters Button -->
                <Button Grid.Column="4"
                       Content="Clear All Filters"
                       Command="{x:Bind ViewModel.ClearFiltersCommand}"
                       Margin="0,26,0,0"
                       VerticalAlignment="Bottom"/>
            </Grid>
        </Grid>

        <!-- Products Grid -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Loading Indicator - Show when loading -->
            <Grid x:Name="LoadingPanel" 
                  Visibility="Collapsed"
                  Background="{ThemeResource LayerFillColorDefaultBrush}">
                <ProgressRing IsActive="True"
                             Width="60"
                             Height="60"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"/>
            </Grid>

            <!-- Content ScrollViewer -->
            <ScrollViewer x:Name="ContentScrollViewer" 
                         VerticalScrollBarVisibility="Auto">
                <Grid>
                    <!-- Products List -->
                    <ListView x:Name="ProductsListView"
                             ItemsSource="{x:Bind ViewModel.Products, Mode=OneWay}"
                             SelectedItem="{x:Bind ViewModel.SelectedProduct, Mode=TwoWay}"
                             SelectionMode="Single">
                        
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="local:Product">
                                <Grid Padding="16,12"
                                     Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                     BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                     BorderThickness="1"
                                     CornerRadius="8"
                                     Margin="0,0,0,8">
                                    
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>    <!-- Image -->
                                        <ColumnDefinition Width="*"/>     <!-- Details -->
                                        <ColumnDefinition Width="Auto"/>  <!-- Actions -->
                                    </Grid.ColumnDefinitions>

                                    <!-- Product Image -->
                                    <Border Grid.Column="0"
                                           Width="64"
                                           Height="64"
                                           CornerRadius="4"
                                           Background="{ThemeResource LayerFillColorAltBrush}"
                                           HorizontalAlignment="Left">
                                        <Image Source="{x:Bind PrimaryImageUrl, Converter={StaticResource StringToImageSourceConverter}}"
                                              Stretch="UniformToFill"/>
                                    </Border>

                                    <!-- Product Details -->
                                    <StackPanel Grid.Column="1" Margin="16,0" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Name}"
                                                  Style="{StaticResource BodyStrongTextBlockStyle}"
                                                  TextTrimming="CharacterEllipsis"/>
                                        
                                        <TextBlock Margin="0,4,0,0" Style="{StaticResource CaptionTextBlockStyle}">
                                            <Run Text="SKU:"/>
                                            <Run Text="{x:Bind Sku}" FontWeight="SemiBold"/>
                                            <Run Text=" | Category: "/>
                                            <Run Text="{x:Bind Category.Name}" FontWeight="SemiBold"/>
                                        </TextBlock>
                                        
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="16">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE8EC;" FontSize="14" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="{x:Bind ImportPrice}" FontWeight="SemiBold"/>
                                                <TextBlock Text="â‚«" FontSize="12" Opacity="0.8"/>
                                            </StackPanel>
                                            
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE7B8;" FontSize="14" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="Stock:"/>
                                                <TextBlock Text="{x:Bind Count}" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Action Buttons -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <Button Click="OnViewProductClick" Tag="{x:Bind ProductId}" ToolTipService.ToolTip="View Details">
                                            <FontIcon Glyph="&#xE700;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnEditProductClick" Tag="{x:Bind ProductId}" ToolTipService.ToolTip="Edit Product">
                                            <FontIcon Glyph="&#xE70F;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnDeleteProductClick"
                                               Tag="{x:Bind ProductId}"
                                               ToolTipService.ToolTip="Delete Product"
                                               Visibility="{Binding ElementName=PageRoot, Path=ViewModel.CanDeleteProducts, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Empty State - Show when no products -->
                    <StackPanel x:Name="EmptyStatePanel"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Spacing="16"
                               Visibility="Collapsed">
                        <FontIcon Glyph="&#xE7C3;" FontSize="64" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                        <TextBlock Text="No products found"
                                  Style="{StaticResource SubtitleTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="Try adjusting your filters or add a new product"
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                  TextAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Pagination Section -->
        <Grid Grid.Row="3"
              Padding="16,12"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="0,16,0,0">
            
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Previous Button -->
            <Button Grid.Column="0"
                   Command="{x:Bind ViewModel.PreviousPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE76B;" FontSize="14"/>
                    <TextBlock Text="Previous"/>
                </StackPanel>
            </Button>

            <!-- Page Info -->
            <StackPanel Grid.Column="1" 
                       Orientation="Horizontal" 
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Spacing="8">
                <TextBlock Text="Page"/>
                <TextBlock Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="of"/>
                <TextBlock Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="â€¢" Margin="8,0"/>
                <TextBlock Text="{x:Bind ViewModel.TotalCount, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="total products"/>
            </StackPanel>

            <!-- Next Button -->
            <Button Grid.Column="2"
                   Command="{x:Bind ViewModel.NextPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Next"/>
                    <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Onboarding Teaching Tip -->
        <TeachingTip
            x:Name="OnboardingTip"
            Title="Welcome!"
            Subtitle="Let's get started"
            ActionButtonContent="Next"
            ActionButtonClick="OnOnboardingNextClicked"
            CloseButtonContent="Skip Tour"
            CloseButtonClick="OnOnboardingSkipClicked"
            PreferredPlacement="Bottom"
            IsLightDismissEnabled="False"
            ShouldConstrainToRootBounds="False">
        </TeachingTip>
    </Grid>
</Page>
