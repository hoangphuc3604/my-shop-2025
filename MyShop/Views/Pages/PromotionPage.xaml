<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Views.Pages.PromotionPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:MyShop.Data.Models"
    xmlns:converters="using:MyShop.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource LayerFillColorDefaultBrush}">

    <Page.Resources>
        <!-- Converters -->
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        <converters:InverseCountToVisibilityConverter x:Key="InverseCountToVisibilityConverter"/>
    </Page.Resources>

    <Grid Padding="24,20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Filters -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="Auto"/> <!-- Pagination -->
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <StackPanel Grid.Row="0" Padding="20" Background="{ThemeResource SystemChromeLowColor}" Margin="0,0,0,16">
            <TextBlock Text="Promotion Management" Style="{StaticResource HeaderTextBlockStyle}" Margin="0,0,0,10"/>
            <TextBlock x:Name="StatusTextBlock"
                      Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                      Style="{StaticResource SubtitleTextBlockStyle}"
                      Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
            <StackPanel x:Name="AddPromotionButton" Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                <Button Content="Add Promotion"
                       Click="OnAddPromotionClick"
                       Style="{StaticResource AccentButtonStyle}"
                       Visibility="{x:Bind ViewModel.CanCreatePromotions, Mode=OneWay}">
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Add new promotion (Ctrl+N)"/>
                    </ToolTipService.ToolTip>
                </Button>

                <Button Command="{x:Bind ViewModel.RefreshCommand}">
                    <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Refresh (F5)"/>
                    </ToolTipService.ToolTip>
                </Button>
            </StackPanel>
        </StackPanel>

        <!-- Filter Section -->
        <Grid Grid.Row="1"
              Padding="16"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="0,0,0,16">

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- First row: Search -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search Box -->
                <TextBox Grid.Column="0"
                        Header="Search"
                        PlaceholderText="Search by code or description..."
                        Text="{x:Bind ViewModel.SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        HorizontalAlignment="Stretch"
                        KeyDown="OnSearchKeyDown"/>

                <Button Grid.Column="1"
                       Command="{x:Bind ViewModel.SearchCommand}"
                       Margin="12,26,0,0"
                       VerticalAlignment="Bottom"
                       Style="{StaticResource AccentButtonStyle}">
                    <FontIcon Glyph="&#xE721;" FontSize="16"/>
                    <ToolTipService.ToolTip>
                        <ToolTip Content="Search (Enter)"/>
                    </ToolTipService.ToolTip>
                </Button>
            </Grid>

            <!-- Second row: Start/End Date Filters and Clear Options -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Date Range Filter -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <CalendarDatePicker x:Name="StartDatePicker"
                                       Header="Start Date"
                                       PlaceholderText="Select start date"
                                       Date="{x:Bind ViewModel.StartDate, Mode=TwoWay}"
                                       DateChanged="OnDateRangeChanged"/>
                    
                    <CalendarDatePicker x:Name="EndDatePicker"
                                       Header="End Date"
                                       PlaceholderText="Select end date"
                                       Date="{x:Bind ViewModel.EndDate, Mode=TwoWay}"
                                       DateChanged="OnDateRangeChanged"/>
                </StackPanel>

                <!-- Clear Filters Button -->
                <Button Grid.Column="5"
                       Content="Clear All Filters"
                       Command="{x:Bind ViewModel.ClearFiltersCommand}"
                       Margin="0,0,0,0"
                       VerticalAlignment="Bottom"
                       HorizontalAlignment="Right"/>
            </Grid>
        </Grid>

        <!-- Promotions Grid -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Loading Indicator -->
            <Grid x:Name="LoadingPanel"
                  Visibility="Collapsed"
                  Background="{ThemeResource LayerFillColorDefaultBrush}">
                <ProgressRing IsActive="True"
                             Width="60"
                             Height="60"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"/>
            </Grid>

            <!-- Content ScrollViewer -->
            <ScrollViewer x:Name="ContentScrollViewer"
                         VerticalScrollBarVisibility="Auto">
                <Grid>
                    <!-- Promotions List -->
                    <ListView x:Name="PromotionsListView"
                             ItemsSource="{x:Bind ViewModel.Promotions, Mode=OneWay}"
                             SelectedItem="{x:Bind ViewModel.SelectedPromotion, Mode=TwoWay}"
                             SelectionMode="Single">

                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="local:Promotion">
                                <Grid Padding="16,12"
                                     Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                     BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                     BorderThickness="1"
                                     CornerRadius="8"
                                     Margin="0,0,0,8">

                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>     <!-- Details -->
                                        <ColumnDefinition Width="Auto"/>  <!-- Actions -->
                                    </Grid.ColumnDefinitions>

                                    <!-- Promotion Details -->
                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Code}"
                                                  Style="{StaticResource BodyStrongTextBlockStyle}"
                                                  TextTrimming="CharacterEllipsis"/>

                                        <TextBlock Margin="0,4,0,0" Style="{StaticResource CaptionTextBlockStyle}">
                                            <Run Text="Description: "/>
                                            <Run Text="{x:Bind Description}" FontWeight="SemiBold"/>
                                        </TextBlock>

                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Spacing="16">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE1D2;" FontSize="14" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="{x:Bind DiscountValue}" FontWeight="SemiBold"/>
                                                <TextBlock Text="{x:Bind DiscountType}" FontSize="12" Opacity="0.8"/>
                                            </StackPanel>

                                            <Border Visibility="{x:Bind IsActive, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                                                   CornerRadius="4" Padding="4,2">
                                                <TextBlock Text="INACTIVE" FontSize="10" FontWeight="Bold"
                                                          Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                            </Border>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Action Buttons -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <Button Click="OnViewPromotionClick" Tag="{x:Bind PromotionId}" ToolTipService.ToolTip="View Details">
                                            <FontIcon Glyph="&#xE700;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnEditPromotionClick" Tag="{x:Bind PromotionId}" ToolTipService.ToolTip="Edit Promotion">
                                            <FontIcon Glyph="&#xE70F;" FontSize="16"/>
                                        </Button>
                                        <Button Click="OnDeletePromotionClick"
                                               Tag="{x:Bind PromotionId}"
                                               ToolTipService.ToolTip="Delete Promotion"
                                               Visibility="{Binding ElementName=PageRoot, Path=ViewModel.CanDeletePromotions, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Empty State -->
                    <StackPanel x:Name="EmptyStatePanel"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Spacing="16"
                               Visibility="Collapsed">
                        <FontIcon Glyph="&#xE1D2;" FontSize="64" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                        <TextBlock Text="No promotions found"
                                  Style="{StaticResource SubtitleTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="Try adjusting your filters or add a new promotion"
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                  TextAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Pagination Section -->
        <Grid Grid.Row="3"
              Padding="16,12"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="0,16,0,0">

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Previous Button -->
            <Button Grid.Column="0"
                   Command="{x:Bind ViewModel.PreviousPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE76B;" FontSize="14"/>
                    <TextBlock Text="Previous"/>
                </StackPanel>
            </Button>

            <!-- Page Info -->
            <StackPanel Grid.Column="1"
                       Orientation="Horizontal"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Spacing="8">
                <TextBlock Text="Page"/>
                <TextBlock Text="{x:Bind ViewModel.CurrentPage, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="of"/>
                <TextBlock Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="â€¢" Margin="8,0"/>
                <TextBlock Text="{x:Bind ViewModel.TotalCount, Mode=OneWay}" FontWeight="SemiBold"/>
                <TextBlock Text="total promotions"/>
            </StackPanel>

            <!-- Next Button -->
            <Button Grid.Column="2"
                   Command="{x:Bind ViewModel.NextPageCommand}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Next"/>
                    <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Onboarding Teaching Tip -->
        <TeachingTip
            x:Name="OnboardingTip"
            Title="Welcome!"
            Subtitle="Let's get started"
            ActionButtonContent="Next"
            ActionButtonClick="OnOnboardingNextClicked"
            CloseButtonContent="Skip Tour"
            CloseButtonClick="OnOnboardingSkipClicked"
            PreferredPlacement="Bottom"
            IsLightDismissEnabled="False"
            ShouldConstrainToRootBounds="False">
        </TeachingTip>
    </Grid>
</Page>
